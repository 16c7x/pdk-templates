---
<% if @configs['override'] && @configs.has_key?('custom') -%>
<%   configs = @configs['custom'] -%>
<% elsif @configs['defaults'] && !@configs.has_key?('custom') -%>
<%   configs = @configs['defaults'] -%>
<% else -%>
<%   require 'deep_merge/core' -%>
<%   defaults = @configs['defaults'].dup -%>
<%   configs = DeepMerge::deep_merge!(defaults, @configs['custom']) -%>
<% end -%>
stages:
<% unless @configs['override'] -%>
  - syntax
  - unit
<% end -%>
<% if configs['beaker'] -%>
  - acceptance
<% end -%>
<% configs['extra_stages'].each do |stage| -%>
  - <%= stage %>
<% end -%>

<% if configs.has_key?('global_variables') -%>
variables:
<%   configs['global_variables'].each do |key, value| -%>
  <%= key %>: <%= value %>
<%   end -%>
<% end -%>

before_script:
  - bundle -v
  - rm Gemfile.lock || true
  - gem update --system
  - gem update bundler
  - gem --version
  - bundle -v
  - bundle install <%= configs['bundler_args'] %>

<% unless @configs['override'] -%>
<%   if configs['ruby_version'] -%>
<%     configs['ruby_version'].each do |ruby_version, options| -%>
<%       options['checks'].each do |check| -%>
<%= check %>:
<%         if check == 'unit' -%>
  stage: unit
<%         else -%>
  stage: syntax
<%         end -%>
  image: ruby:<%= ruby_version %>
  script:
    - bundle exec rake <%= check %>
<%       end -%>
<%     end -%>
<%   end -%>
<% end -%>

<% configs['jobs'].each do |job, params| -%>
<%= job %>:
<%-   params.keys.sort.each do |key| -%>
<%-     if params[key].is_a?(Array) -%>
  <%= key -%>:
    <%-   params[key].each do |element| -%>
    - <%= element %>
    <%-   end -%>
<%-     else -%>
  <%= key %>: <%= params[key] %>
<%     end -%>
<%   end -%>
<% end -%>
