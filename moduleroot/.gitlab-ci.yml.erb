---
<% if @configs['override'] && @configs.has_key?('custom') -%>
<%   configs = @configs['custom'] -%>
<% elsif @configs['defaults'] && !@configs.has_key?('custom') -%>
<%   configs = @configs['defaults'] -%>
<% else -%>
<%   require 'deep_merge/core' -%>
<%   defaults = @configs['defaults'].dup -%>
<%   configs = DeepMerge::deep_merge!(defaults, @configs['custom']) -%>
<% end -%>
stages:
<% configs['stages'].each do |stage| -%>
  - <%= stage %>
<% end -%>

<% if configs.has_key?('variables') -%>
variables:
<%   configs['variables'].each do |variable, value| -%>
  <%= variable %>: <%= value %>
<%   end -%>
<% end -%>

before_script:
  - bundle -v
  - rm Gemfile.lock || true
  - gem update --system
  - gem update bundler
  - gem --version
  - bundle -v
  - bundle install <%= configs['bundler_args'] %>

<% configs['jobs'].each do |job, params| -%>
<%= job %>:
<%-   params.keys.sort.each do |key| -%>
<%-     if params[key].is_a?(Array) -%>
  <%= key -%>:
    <%-   params[key].each do |element| -%>
    - <%= element %>
    <%-   end -%>
<%-     else -%>
  <%= key %>: <%= params[key] %>
<%     end -%>
<%   end -%>
<% end -%>
